<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin PDF Management - ระบบจัดการ PDF สำหรับแอดมิน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'THSarabunPsk';
            src: url('https://oldqifkvaagtseibueaf.supabase.co/storage/v1/object/public/zzoo/ozz/ss-thsbn.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            unicode-range: U+0E00-0E7F, U+0020-007F, U+00A0-00FF;
            font-display: swap;
        }
        @font-face {
            font-family: 'THSarabunPsk';
            src: url('https://oldqifkvaagtseibueaf.supabase.co/storage/v1/object/public/zzoo/ozz/ss-thsbn-bold.woff2') format('woff2');
            font-weight: bold;
            font-style: normal;
            unicode-range: U+0E00-0E7F, U+0020-007F, U+00A0-00FF;
            font-display: swap;
        }
        
        * {
            font-family: 'THSarabunPsk', sans-serif;
        }
        
        .worker-card {
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }
        
        .worker-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .worker-card.selected {
            border: 3px solid #3b82f6;
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        }
        
        .worker-card.selecting {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .pdf-preview {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .selection-mode {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
        }
        
        .long-press-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 9999;
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Long Press Indicator -->
    <div id="longPressIndicator" class="long-press-indicator">
        <i class="fas fa-hand-paper text-2xl mb-2"></i>
        <p>กดค้างเพื่อเลือกหลายรายการ</p>
        <div class="w-full bg-gray-600 rounded-full h-2 mt-2">
            <div id="longPressProgress" class="bg-blue-500 h-2 rounded-full transition-all duration-100" style="width: 0%"></div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 shadow-lg">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-3xl font-bold text-center mb-4">
                <i class="fas fa-cogs mr-3"></i>
                Admin PDF Management System
            </h1>
            <p class="text-center text-blue-100">ระบบจัดการดาวน์โหลด PDF สำหรับแอดมิน</p>
        </div>
    </header>

    <div class="max-w-7xl mx-auto p-6">
        <!-- Search Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-search mr-2"></i>ค้นหาด้วย Session / ชื่อ
                    </label>
                    <input type="text" id="searchInput" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="พิมพ์ session, ชื่อไทย, ชื่ออังกฤษ...">
                </div>
                <div class="flex items-end">
                    <button id="clearSearch" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        <i class="fas fa-times mr-2"></i>ล้าง
                    </button>
                </div>
            </div>
        </div>

        <!-- Selection Controls -->
        <div id="selectionControls" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 hidden">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <span class="text-yellow-800 font-medium">
                        <i class="fas fa-check-square mr-2"></i>
                        เลือกแล้ว <span id="selectedCount">0</span> รายการ
                    </span>
                    <button id="selectAll" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-sm">
                        <i class="fas fa-check-double mr-1"></i>เลือกทั้งหมด
                    </button>
                    <button id="clearSelection" class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors text-sm">
                        <i class="fas fa-times mr-1"></i>ยกเลิกเลือก
                    </button>
                </div>
                <button id="downloadSelected" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                    <i class="fas fa-download mr-2"></i>ดาวน์โหลดที่เลือก (<span id="downloadCount">0</span>)
                </button>
            </div>
        </div>

        <!-- Workers Grid -->
        <div id="workersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-6">
            <!-- Worker cards will be dynamically inserted here -->
        </div>

        <!-- PDF Preview Section -->
        <div id="pdfPreview" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-file-pdf text-red-500 mr-3"></i>
                        ตัวอย่าง PDF ที่เลือก
                    </h2>
                    <div class="flex space-x-2">
                        <button id="previewPage1" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-file-alt mr-2"></i>หน้า 1
                        </button>
                        <button id="previewPage2" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors">
                            <i class="fas fa-file-invoice mr-2"></i>หน้า 2
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Page 1 Preview -->
                    <div class="pdf-preview">
                        <div class="bg-gray-50 p-4 border-b">
                            <h3 class="font-semibold text-gray-700">
                                <i class="fas fa-file-alt mr-2"></i>หน้า 1 - ใบอนุญาตทำงาน
                            </h3>
                        </div>
                        <div id="page1Preview" class="p-4">
                            <!-- Page 1 content will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Page 2 Preview -->
                    <div class="pdf-preview">
                        <div class="bg-gray-50 p-4 border-b">
                            <h3 class="font-semibold text-gray-700">
                                <i class="fas fa-file-invoice mr-2"></i>หน้า 2 - ใบเสร็จรับเงิน
                            </h3>
                        </div>
                        <div id="page2Preview" class="p-4">
                            <!-- Page 2 content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AdminPDFManager {
            constructor() {
                this.workers = [];
                this.selectedWorkers = new Set();
                this.isSelectionMode = false;
                this.longPressTimer = null;
                this.longPressDelay = 800; // 800ms for long press
                
                this.init();
            }
            
            async init() {
                await this.loadWorkers();
                this.setupEventListeners();
                this.renderWorkers();
            }
            
            async loadWorkers() {
                try {
                    const response = await fetch('combined-data.json');
                    this.workers = await response.json();
                    console.log('Loaded workers:', this.workers.length);
                } catch (error) {
                    console.error('Error loading workers:', error);
                    alert('เกิดข้อผิดพลาดในการโหลดข้อมูลคนงาน');
                }
            }
            
            setupEventListeners() {
                // Search functionality
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.filterWorkers(e.target.value);
                });
                
                document.getElementById('clearSearch').addEventListener('click', () => {
                    document.getElementById('searchInput').value = '';
                    this.filterWorkers('');
                });
                
                // Selection controls
                document.getElementById('selectAll').addEventListener('click', () => {
                    this.selectAll();
                });
                
                document.getElementById('clearSelection').addEventListener('click', () => {
                    this.clearSelection();
                });
                
                document.getElementById('downloadSelected').addEventListener('click', () => {
                    this.downloadSelected();
                });
                
                // Preview controls
                document.getElementById('previewPage1').addEventListener('click', () => {
                    this.showPreview('page1');
                });
                
                document.getElementById('previewPage2').addEventListener('click', () => {
                    this.showPreview('page2');
                });
            }
            
            filterWorkers(searchTerm) {
                const term = searchTerm.toLowerCase().trim();
                const cards = document.querySelectorAll('.worker-card');
                
                cards.forEach(card => {
                    const workerId = card.dataset.workerId;
                    const worker = this.workers.find(w => w.requestNumber === workerId);
                    
                    if (!worker) return;
                    
                    const matchesSearch = 
                        worker.requestNumber.toLowerCase().includes(term) ||
                        (worker.thaiName && worker.thaiName.toLowerCase().includes(term)) ||
                        (worker.englishName && worker.englishName.toLowerCase().includes(term)) ||
                        (worker.nationality && worker.nationality.toLowerCase().includes(term));
                    
                    card.style.display = matchesSearch ? 'block' : 'none';
                });
            }
            
            renderWorkers() {
                const grid = document.getElementById('workersGrid');
                grid.innerHTML = '';
                
                this.workers.forEach(worker => {
                    const card = this.createWorkerCard(worker);
                    grid.appendChild(card);
                });
            }
            
            createWorkerCard(worker) {
                const card = document.createElement('div');
                card.className = 'worker-card bg-white rounded-lg shadow-md overflow-hidden';
                card.dataset.workerId = worker.requestNumber;
                
                const profileImage = worker.profileImage || 'https://via.placeholder.com/150x150?text=No+Image';
                const displayName = worker.thaiName || worker.englishName || worker.requestNumber;
                const sessionName = worker.requestNumber || 'N/A';
                
                card.innerHTML = `
                    <div class="relative">
                        <img src="${profileImage}" alt="${displayName}" 
                             class="w-full h-32 object-cover"
                             onerror="this.src='https://via.placeholder.com/150x150?text=No+Image'">
                        <div class="absolute top-2 right-2">
                            <div class="bg-blue-500 text-white px-2 py-1 rounded-full text-xs font-semibold">
                                ${sessionName}
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-gray-800 mb-1">${displayName}</h3>
                        <p class="text-sm text-gray-600 mb-2">${worker.englishName || ''}</p>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span><i class="fas fa-flag mr-1"></i>${worker.nationality || 'N/A'}</span>
                            <span><i class="fas fa-id-card mr-1"></i>${worker.personalID || 'N/A'}</span>
                        </div>
                        <div class="mt-3 flex space-x-2">
                            <button onclick="adminManager.downloadSingle('${worker.requestNumber}')" 
                                    class="flex-1 px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-sm">
                                <i class="fas fa-download mr-1"></i>PDF
                            </button>
                            <button onclick="adminManager.previewWorker('${worker.requestNumber}')" 
                                    class="flex-1 px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 transition-colors text-sm">
                                <i class="fas fa-eye mr-1"></i>ดู
                            </button>
                        </div>
                    </div>
                `;
                
                // Setup long press for selection
                this.setupLongPress(card, worker);
                
                return card;
            }
            
            setupLongPress(card, worker) {
                let pressTimer = null;
                let progressInterval = null;
                
                const startPress = () => {
                    pressTimer = setTimeout(() => {
                        this.toggleSelection(worker, card);
                        this.showLongPressSuccess();
                    }, this.longPressDelay);
                    
                    // Show progress indicator
                    const indicator = document.getElementById('longPressIndicator');
                    const progress = document.getElementById('longPressProgress');
                    indicator.style.display = 'block';
                    
                    let progressValue = 0;
                    progressInterval = setInterval(() => {
                        progressValue += (100 / (this.longPressDelay / 100));
                        progress.style.width = Math.min(progressValue, 100) + '%';
                    }, 100);
                };
                
                const endPress = () => {
                    clearTimeout(pressTimer);
                    clearInterval(progressInterval);
                    
                    const indicator = document.getElementById('longPressIndicator');
                    const progress = document.getElementById('longPressProgress');
                    indicator.style.display = 'none';
                    progress.style.width = '0%';
                };
                
                card.addEventListener('mousedown', startPress);
                card.addEventListener('mouseup', endPress);
                card.addEventListener('mouseleave', endPress);
                card.addEventListener('touchstart', startPress);
                card.addEventListener('touchend', endPress);
            }
            
            showLongPressSuccess() {
                // Visual feedback for successful long press
                const indicator = document.getElementById('longPressIndicator');
                indicator.innerHTML = `
                    <i class="fas fa-check-circle text-green-400 text-2xl mb-2"></i>
                    <p class="text-green-400">เลือกรายการแล้ว!</p>
                `;
                indicator.style.display = 'block';
                
                setTimeout(() => {
                    indicator.style.display = 'none';
                    indicator.innerHTML = `
                        <i class="fas fa-hand-paper text-2xl mb-2"></i>
                        <p>กดค้างเพื่อเลือกหลายรายการ</p>
                        <div class="w-full bg-gray-600 rounded-full h-2 mt-2">
                            <div id="longPressProgress" class="bg-blue-500 h-2 rounded-full transition-all duration-100" style="width: 0%"></div>
                        </div>
                    `;
                }, 1000);
            }
            
            toggleSelection(worker, card) {
                const workerId = worker.requestNumber;
                
                if (this.selectedWorkers.has(workerId)) {
                    this.selectedWorkers.delete(workerId);
                    card.classList.remove('selected');
                } else {
                    this.selectedWorkers.add(workerId);
                    card.classList.add('selected');
                }
                
                this.updateSelectionUI();
            }
            
            updateSelectionUI() {
                const count = this.selectedWorkers.size;
                const controls = document.getElementById('selectionControls');
                const selectedCount = document.getElementById('selectedCount');
                const downloadCount = document.getElementById('downloadCount');
                
                selectedCount.textContent = count;
                downloadCount.textContent = count;
                
                if (count > 0) {
                    controls.classList.remove('hidden');
                    document.body.classList.add('selection-mode');
                } else {
                    controls.classList.add('hidden');
                    document.body.classList.remove('selection-mode');
                }
            }
            
            selectAll() {
                const visibleCards = document.querySelectorAll('.worker-card:not([style*="display: none"])');
                visibleCards.forEach(card => {
                    const workerId = card.dataset.workerId;
                    this.selectedWorkers.add(workerId);
                    card.classList.add('selected');
                });
                this.updateSelectionUI();
            }
            
            clearSelection() {
                this.selectedWorkers.clear();
                document.querySelectorAll('.worker-card').forEach(card => {
                    card.classList.remove('selected');
                });
                this.updateSelectionUI();
            }
            
            async downloadSingle(workerId) {
                try {
                    const worker = this.workers.find(w => w.requestNumber === workerId);
                    if (!worker) return;
                    
                    // Use worker name for filename
                    const workerName = worker.thaiName || worker.englishName || workerId;
                    const cleanName = workerName.replace(/[^a-zA-Z0-9\u0E00-\u0E7F\s]/g, '').trim();
                    const filename = `${cleanName}.pdf`;
                    
                    const response = await fetch(`/.netlify/functions/generate-pdf?workerId=${workerId}&admin=true`);
                    if (!response.ok) throw new Error('Download failed');
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Download error:', error);
                    alert('เกิดข้อผิดพลาดในการดาวน์โหลด');
                }
            }
            
            async downloadSelected() {
                const workerIds = Array.from(this.selectedWorkers);
                if (workerIds.length === 0) return;
                
                for (let i = 0; i < workerIds.length; i++) {
                    const workerId = workerIds[i];
                    await this.downloadSingle(workerId);
                    
                    // Small delay between downloads
                    if (i < workerIds.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
            }
            
            previewWorker(workerId) {
                const worker = this.workers.find(w => w.requestNumber === workerId);
                if (!worker) return;
                
                this.loadWorkerPreview(worker);
                document.getElementById('pdfPreview').classList.remove('hidden');
                document.getElementById('pdfPreview').scrollIntoView({ behavior: 'smooth' });
            }
            
            loadWorkerPreview(worker) {
                // Load page 1 preview
                this.loadSVGPreview('page1Preview', 'complete-page1.svg', worker);
                
                // Load page 2 preview
                this.loadSVGPreview('page2Preview', 'complete-page2.svg', worker);
            }
            
            loadSVGPreview(containerId, svgFile, worker) {
                const container = document.getElementById(containerId);
                container.innerHTML = '<div class="text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>กำลังโหลด...</div>';
                
                fetch(svgFile)
                    .then(response => response.text())
                    .then(svgContent => {
                        let updatedSVG = svgContent;
                        
                        // Replace worker data in SVG
                        Object.keys(worker).forEach(key => {
                            const value = worker[key] || '';
                            const regex = new RegExp(`id="svg-${key}"[^>]*>[^<]*`, 'g');
                            updatedSVG = updatedSVG.replace(regex, `id="svg-${key}">${value}`);
                        });
                        
                        // Scale down for preview
                        updatedSVG = updatedSVG.replace('width="892"', 'width="100%"');
                        updatedSVG = updatedSVG.replace('height="1261"', 'height="auto"');
                        
                        container.innerHTML = updatedSVG;
                    })
                    .catch(error => {
                        container.innerHTML = '<div class="text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>เกิดข้อผิดพลาดในการโหลด</div>';
                    });
            }
            
            showPreview(page) {
                const page1Btn = document.getElementById('previewPage1');
                const page2Btn = document.getElementById('previewPage2');
                
                if (page === 'page1') {
                    page1Btn.classList.add('bg-blue-600');
                    page1Btn.classList.remove('bg-blue-500');
                    page2Btn.classList.add('bg-purple-500');
                    page2Btn.classList.remove('bg-purple-600');
                } else {
                    page2Btn.classList.add('bg-purple-600');
                    page2Btn.classList.remove('bg-purple-500');
                    page1Btn.classList.add('bg-blue-500');
                    page1Btn.classList.remove('bg-blue-600');
                }
            }
        }
        
        // Initialize the admin manager
        const adminManager = new AdminPDFManager();
    </script>
</body>
</html>